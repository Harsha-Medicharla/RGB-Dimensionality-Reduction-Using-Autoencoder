<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Processing Results</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Poppins', 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
  color: #333;
}

/* Main Container */
.container {
  max-width: 1250px;
  margin: auto;
  background: #ffffff;
  padding: 40px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  animation: fadeIn 0.8s ease;
}

/* Header */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  padding-bottom:20px;
  border-bottom:2px solid #f0f0f0;
}
.header h2 {
  font-size:28px;
  color:#333;
  font-weight:700;
}
.nav-links a {
  text-decoration:none;
  color:#667eea;
  font-weight:600;
  margin-left:20px;
  transition:0.3s;
}
.nav-links a:hover {
  color:#764ba2;
  text-decoration:underline;
}

/* Results Header */
.results-header {
  text-align:center;
  margin-bottom:30px;
}
.results-header h3 {
  font-size:26px;
  color:#333;
  margin-bottom:8px;
  font-weight:700;
}
.upload-info {
  font-size:14px;
  color:#666;
}

/* Status Box */
.processing-status {
  text-align:center;
  padding:20px;
  border-radius:10px;
  margin-bottom:30px;
  font-size:16px;
  font-weight:600;
}
.processing-status.success {
  background:#d4edda;
  color:#155724;
  border:2px solid #c3e6cb;
}
.processing-status.in-progress {
  background:#fff3cd;
  color:#856404;
  border:2px solid #ffeaa7;
}
.status-icon {
  font-size:48px;
  margin-bottom:10px;
}

/* Action Buttons */
.action-buttons {
  display:flex;
  justify-content:center;
  gap:15px;
  margin-bottom:30px;
  flex-wrap:wrap;
}
.btn {
  padding:12px 28px;
  border-radius:8px;
  font-size:16px;
  font-weight:600;
  text-decoration:none;
  color:#fff;
  border:none;
  cursor:pointer;
  transition:all 0.3s ease;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
}
.btn-success {
  background: linear-gradient(135deg, #28a745, #52b788);
}
.btn-secondary {
  background: linear-gradient(135deg, #6c757d, #adb5bd);
}
.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

/* Image Comparison */
.comparison {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:30px;
  margin-bottom:40px;
}
.image-box {
  text-align:center;
  background:#f9f9f9;
  border-radius:12px;
  padding:20px;
  border:2px solid #e0e0e0;
  transition:all 0.3s ease;
}
.image-box:hover {
  transform:translateY(-5px);
  box-shadow:0 8px 25px rgba(102, 126, 234, 0.3);
  border-color:#667eea;
}
.image-label {
  font-size:18px;
  font-weight:600;
  margin-bottom:15px;
  color:#fff;
  background:linear-gradient(135deg, #667eea, #764ba2);
  padding:10px;
  border-radius:8px;
}
.image-wrapper {
  background:#fff;
  padding:15px;
  border-radius:8px;
  border:2px solid #eee;
}
.result-image {
  max-width:100%;
  border-radius:5px;
  image-rendering: pixelated;
  image-rendering: -moz-crisp-edges;
  image-rendering: crisp-edges;
}
.image-dimensions {
  font-size:13px;
  color:#999;
  margin-top:10px;
  font-weight:500;
}

/* Metrics Box */
.metrics {
  background:linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding:30px;
  border-radius:12px;
  text-align:center;
  border:2px solid #dee2e6;
  margin-bottom:30px;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
}
.metrics h3 {
  font-size:24px;
  margin-bottom:20px;
  color:#333;
  font-weight:700;
}
.metrics-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap:20px;
  margin-top:15px;
}
.metric-item {
  background:#fff;
  padding:15px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.metric-item strong {
  display:block;
  font-size:14px;
  color:#667eea;
  margin-bottom:5px;
}
.metric-value {
  font-size:22px;
  font-weight:700;
  color:#333;
}

/* Chart Section */
.charts {
  background:#f9fafc;
  padding:30px;
  border-radius:12px;
  border:2px solid #e0e0e0;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
  margin-bottom:30px;
}
.charts h3 {
  font-size:22px;
  margin-bottom:20px;
  color:#333;
  text-align:center;
  font-weight:700;
}
.chart-container {
  margin-bottom:40px;
}
canvas {
  max-width: 100%;
  height: 300px !important;
  margin: 0 auto;
  display: block;
}

/* Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width:768px) {
  .comparison { 
    grid-template-columns: 1fr;
    gap: 20px;
  }
  .action-buttons { 
    flex-direction:column; 
  }
  .btn { 
    width: 100%; 
  }
  .metrics-grid {
    grid-template-columns: 1fr;
  }
}
</style>

</head>
<body>

<div class="container">

    <div class="header">
        <h2>Image Processing Results</h2>
        <div class="nav-links">
            <a href="{% url 'account:home' %}">← Home</a>
            <a href="{% url 'account:profile' %}">Profile</a>
        </div>
    </div>

    <div class="results-header">
        <h3>Processing Complete</h3>
        <div class="upload-info">
            Uploaded: {{ image_upload.uploaded_at|date:"F d, Y at H:i" }}
        </div>
    </div>

    {% if image_upload.processed %}
        <!-- Success Status -->
        <div class="processing-status success">
            <div class="status-icon">✓</div>
            <div class="status-text">Processing completed successfully!</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="{{ image_upload.output_image.url }}" download class="btn btn-success">
                Download Output
            </a>
            <a href="{% url 'account:home' %}" class="btn btn-primary">
                Upload Another
            </a>
        </div>

        <!-- Images Comparison -->
        <div class="comparison">
            <div class="image-box">
                <div class="image-label">Input Image</div>
                <div class="image-wrapper">
                    <img src="{{ image_upload.input_image.url }}" alt="Input Image" class="result-image">
                    <div class="image-dimensions">96x96 pixels</div>
                </div>
            </div>
            <div class="image-box">
                <div class="image-label">Output Image</div>
                <div class="image-wrapper">
                    <img src="{{ image_upload.output_image.url }}" alt="Output Image" class="result-image">
                    <div class="image-dimensions">48x48 pixels</div>
                </div>
            </div>
        </div>

        <!-- Metrics (only if available) -->
        {% if metrics %}
        <div class="metrics">
            <h3>Quality Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-item">
                    <strong>MSE (Mean Squared Error)</strong>
                    <div class="metric-value">{{ metrics.MSE }}</div>
                </div>
                <div class="metric-item">
                    <strong>PSNR (Peak Signal-to-Noise Ratio)</strong>
                    <div class="metric-value">{{ metrics.PSNR }} dB</div>
                </div>
                <div class="metric-item">
                    <strong>SSIM (Structural Similarity)</strong>
                    <div class="metric-value">{{ metrics.SSIM }}</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts">
            <div class="chart-container">
                <h3>Pixel Difference Histogram</h3>
                <canvas id="differenceChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Input vs Output Intensity Distribution</h3>
                <canvas id="histogramChart"></canvas>
            </div>
        </div>
        {% endif %}

    {% else %}
        <!-- Processing In Progress -->
        <div class="processing-status in-progress">
            <div class="status-icon">⏳</div>
            <div class="status-text">Processing in progress...</div>
        </div>
        <div class="action-buttons">
            <button onclick="window.location.reload()" class="btn btn-secondary">
                Refresh Page
            </button>
            <a href="{% url 'account:home' %}" class="btn btn-primary">
                Back to Home
            </a>
        </div>
    {% endif %}

</div>

{% if image_upload.processed and metrics %}
<script>
// Get data from Django template
const pixelDiff = {{ metrics.pixel_diff_histogram|default:"[]"|safe }};
const inputHist = {{ metrics.input_hist|default:"[]"|safe }};
const outputHist = {{ metrics.output_hist|default:"[]"|safe }};

// Pixel Difference Histogram
new Chart(document.getElementById('differenceChart').getContext('2d'), {
    type: 'line',
    data: {
        labels: [...Array(256).keys()],
        datasets: [{
            label: 'Pixel Difference Frequency',
            data: pixelDiff,
            borderColor: 'rgba(255, 159, 64, 1)',
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Pixel Intensity Difference',
                    font: { size: 14, weight: 'bold' }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Frequency',
                    font: { size: 14, weight: 'bold' }
                },
                beginAtZero: true
            }
        }
    }
});

// Input vs Output Histogram
new Chart(document.getElementById('histogramChart').getContext('2d'), {
    type: 'line',
    data: {
        labels: [...Array(256).keys()],
        datasets: [
            {
                label: 'Input Image (96x96 resized to 48x48)',
                data: inputHist,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2
            },
            {
                label: 'Output Image (48x48)',
                data: outputHist,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Pixel Intensity (0-255)',
                    font: { size: 14, weight: 'bold' }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Frequency',
                    font: { size: 14, weight: 'bold' }
                },
                beginAtZero: true
            }
        }
    }
});
</script>
{% endif %}

</body>
</html>
